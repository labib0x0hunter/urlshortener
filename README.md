# shrinkr - A Url Shortener

A simple URL shortener service written in Go, using Gin for HTTP routing, MySQL for persistent storage, and Redis for caching.
**Comments are generated by ai. :)**

## Features
- Shorten long URLs to short codes
- Redirect short codes to original URLs
- Optional expiration for short URLs
- Caching with Redis for fast lookups
- Graceful shutdown and error handling
- Rate limiting middleware for abuse prevention

## Project Structure
- `main.go`: Application entry point, server setup, graceful shutdown
- `handlers/`: HTTP handlers for shortening and redirecting URLs
- `services/`: Business logic for URL creation and lookup
- `repositories/`: Data access layers for MySQL and Redis+MySQL
- `models/`: Data models (e.g., Url struct)
- `db/`: MySQL connection and setup
- `redis/`: Redis client setup
- `cache/`: Cache interface and Redis implementation
- `utils/`: Short code generation utilities
- `middleware/`: Custom middleware (e.g., rate limiting)

## Middleware System
This project uses a middleware system to enhance security and control request flow:
- **Rate Limiting Middleware**: Limits the number of requests per user (based on User-Agent or authentication status) to prevent abuse.
  - Unauthorized users: up to 5 short URLs per hour.
  - Authorized users: up to 50 short URLs per day (TO-DO)

## How to Use
1. **Shorten a URL**
   - Send a `POST` request to `/shorten` with JSON body:
     ```json
     {
       "url": "https://example.com",
       "expire_in": 60 // (optional) expiration in minutes
     }
     ```
   - Response:
     ```json
     {
       "message": "success",
       "short_url": "http://localhost:8080/IrLvWOeO",
       "expire_at" : "2025-05-12 12:23:06"
     }
     ```
2. **Redirect to Original URL**
   - Access `GET /:code` (e.g., `/IrLvWOeO`)
   - If the code exists and is not expired, you will be redirected to the original URL.
3. **Fetch metadata of short URL**
   - Access `GET /fetch/:code` (e.g., `/fetch/IrLvWOeO`)
   - If the code exists , you will see the Metadata of the short URL.


## Environment Variables
- `SERVER_HOST`: Host for the HTTP server (e.g., 0.0.0.0)
- `PORT`: Port for the HTTP server (e.g., 8080)
- `MYSQL_DB`, `MYSQL_HOST`, `MYSQL_PORT`, `MYSQL_USER`, `MYSQL_PASSWORD`: MySQL connection
- `REDIS_HOST`, `REDIS_PORT`: Redis connection
- `SHORT_URL_PREFIX`: Prefix for returned short URLs (e.g., http://localhost:3000/)

# MySql Setup
**Create Database**
```sql
CREATE DATABASE urlshortener;
```
**Create Table**
```sql
USE urlshortener;

CREATE TABLE urls (
    id INT AUTO_INCREMENT PRIMARY KEY,
    url TEXT NOT NULL,
    short_url VARCHAR(64) NOT NULL UNIQUE,
    created_at DATETIME NOT NULL,
    expire DATETIME
);
```

# How the URL Shortening Algorithm Works
- The service combines the original URL, a hash of the user agent, and a UUID to ensure uniqueness.
- It computes the SHA1 hash of this combination.
- The first 6 bytes of the hash are converted to a base62 string to create the short code.

## Flow
1. Client sends a POST request to `/shorten` with a URL (and optional expiration).
2. The service generates a unique short code using SHA1 and base62 encoding.
3. The mapping is stored in MySQL and cached in Redis for fast access.
4. Accessing `/:code` redirects to the original URL if it exists and is not expired.

## TO-Do
- User authentication (sign up, login, JWT/session support)
- User dashboard for managing their own short URLs
- URL management (view, edit, delete, extend expiration)
- Custom short code support
- Email verification and password reset
- Improved test coverage and CI integration
- Unauthorized user can only generate up to 5 short-urls per hour, authorized user can generate up to 20 per day.
- Integrate RabbitMQ
- Add and improve unit testing 

## Resources
**url-shorten-algo**
- https://microsoft.github.io/makecode-csp/unit-6/day-14/base63-url-shorteners
- https://www.linkedin.com/pulse/building-url-shortener-using-hash-functions-base62-conversion-singh-y01oc/
**redis**
- https://redis.io/docs/latest/develop/clients/go/
**mysql**
- https://go.dev/doc/tutorial/database-access
